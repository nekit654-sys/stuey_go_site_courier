<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞</title>
<style>
  /* --- –°–±—Ä–æ—Å –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ --- */
  *, *::before, *::after {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  html, body {
    height: 100%;
    width: 100%;
    overflow: hidden;
    font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;
    background: linear-gradient(#555 10%, #444 50%, #555 90%);
    color: #FFD700;
    user-select: none;
  }
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã --- */
  #container {
    flex: 1 1 auto;
    width: 100vw;
    max-width: 100vw;
    max-height: 100vh;
    display: flex;
    flex-direction: column;
    background: transparent;
  }

  /* --- –í–µ—Ä—Ö–Ω—è—è –∏ –Ω–∏–∂–Ω—è—è –ø–æ–ª–æ—Å—ã —Å –ª–µ—Å–æ–º --- */
  .city-strip {
    flex-shrink: 0;
    height: clamp(3rem, 8vw, 5rem);
    background: linear-gradient(to bottom, #2e7d32, #145214);
    overflow: hidden;
    position: relative;
    font-size: clamp(2rem, 6vw, 3rem);
    line-height: clamp(3rem, 8vw, 5rem);
    white-space: nowrap;
    color: #a5d6a7;
  }
  .scrolling-objects {
    position: absolute;
    top: 0; left: 0;
    height: 100%;
    width: 200%;
    white-space: nowrap;
    animation: scrollLeft 20s linear infinite;
    font-size: clamp(2rem, 6vw, 3rem);
  }
  @keyframes scrollLeft {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }

  /* --- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ —Å 5 –ø–æ–ª–æ—Å–∞–º–∏ --- */
  #game {
    flex: 1 1 auto;
    position: relative;
    width: 100%;
    max-width: 100vw;
    height: 100%;
    max-height: calc(100vh - 2 * clamp(3rem, 8vw, 5rem));
    box-shadow: inset 0 0 2vw #222;
    overflow: hidden;

    display: flex;
    flex-direction: column;
    justify-content: space-around;
    padding: 0 1vw;

    background: none;
  }
  .lane {
    flex: 1;
    position: relative;
    border: none;
    background: transparent;
    overflow: visible;
  }
  .lane::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    height: 6px;
    background:
      repeating-linear-gradient(
        to right,
        white 0,
        white 20px,
        transparent 20px,
        transparent 40px
      );
    opacity: 0.6;
    transform: translateY(-50%);
    animation: dashMove linear infinite;
    pointer-events: none;
    z-index: 2;
    animation-duration: 1s;
  }
  @keyframes dashMove {
    0% {
      background-position: 0 0;
    }
    100% {
      background-position: -40px 0;
    }
  }

  /* --- –ö—É—Ä—å–µ—Ä —Å —Å–æ–±–∞–∫–æ–π —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏—è --- */
  #courier {
    position: absolute;
    left: 10%;
    font-size: clamp(3rem, 8vw, 4rem);
    user-select: none;
    pointer-events: none;
    z-index: 10;
    text-shadow: 1px 1px 0.2vw #2e1b0c;
    transform-origin: center bottom;
    animation: sway 2s ease-in-out infinite;
    width: 1em;
    height: 1em;
    transform-origin: center bottom;
    transform-style: preserve-3d;
    transform-box: fill-box;
    transform: scaleX(-1);
    transition: top 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  }
  @keyframes sway {
    0%, 100% { transform: scaleX(-1) translateX(0) rotate(0deg); }
    25% { transform: scaleX(-1) translateX(-0.1em) rotate(-3deg); }
    50% { transform: scaleX(-1) translateX(0) rotate(0deg); }
    75% { transform: scaleX(-1) translateX(0.1em) rotate(3deg); }
  }
  #dog {
    position: absolute;
    top: 0;
    left: 0.6em;
    font-size: 0.625em;
    opacity: 0.7;
    user-select: none;
    pointer-events: none;
    z-index: 0;
    animation: rideDog 1s ease-in-out infinite;
    transform-origin: center center;
  }
  #helmet {
    position: absolute;
    top: 0.1em;
    left: 0.6em;
    width: 0.2em;
    height: 0.15em;
    background: gold;
    border-radius: 1rem 1rem 0 0;
    box-shadow: inset 0 -0.3rem 0.2rem #cc9f00;
    z-index: 0;
    animation: rideDog 1s ease-in-out infinite;
  }
  #scooter {
    position: relative;
    z-index: 1;
    user-select: none;
    pointer-events: none;
    animation: rideScooter 1s ease-in-out infinite;
    transform-origin: center bottom;
  }
  @keyframes rideScooter {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-0.3rem) rotate(-3deg); }
    50% { transform: translateY(0) rotate(0deg); }
    75% { transform: translateY(-0.3rem) rotate(3deg); }
  }
  @keyframes rideDog {
    0%, 100% { transform: translateY(0); }
    25% { transform: translateY(-0.2rem); }
    50% { transform: translateY(0); }
    75% { transform: translateY(-0.2rem); }
  }

  /* --- –û–±–ª–∞–∫–æ —Ä–µ—á–∏ –∫—É—Ä—å–µ—Ä–∞ (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ) --- */
  #speechBubble {
    position: absolute;
    background: #222c;
    color: #fff;
    padding: 0.4rem 0.8rem;
    border-radius: 0.6rem;
    font-size: clamp(0.8rem, 2vw, 1rem);
    max-width: 90vw;
    width: auto;
    pointer-events: none;
    user-select: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    box-shadow: 0 0 0.3rem #000a;
    z-index: 20;
    font-weight: 600;
    white-space: nowrap;
  }
  #speechBubble::after {
    content: "";
    position: absolute;
    bottom: -0.4rem;
    left: 50%;
    transform: translateX(-50%);
    border-width: 0.4rem 0.4rem 0 0.4rem;
    border-style: solid;
    border-color: #222c transparent transparent transparent;
  }

  /* --- –û–±—ä–µ–∫—Ç—ã --- */
  .pedestrian, .food, .medkit, .bonus, .policeCar, .policeStanding {
    position: absolute;
    font-size: clamp(2rem, 6vw, 3rem);
    user-select: none;
    pointer-events: none;
    z-index: 5;
    transition: transform 0.2s ease;
    text-shadow: 1px 1px 0.1vw #422d1f;
  }
  .pedestrian {
    filter: drop-shadow(0 0 0.15rem #8b0000);
  }
  .food {
    filter: drop-shadow(0 0 0.2rem #ffd54f);
    text-shadow: 1px 1px 0.1vw #7a4a19;
  }
  .medkit {
    filter: drop-shadow(0 0 0.25rem #e57373);
    text-shadow: 1px 1px 0.1vw #c62828;
  }
  .bonus {
    filter: drop-shadow(0 0 0.25rem #64b5f6);
    text-shadow: 1px 1px 0.1vw #1565c0;
  }
  .policeCar {
    filter: drop-shadow(0 0 0.3rem #2196f3);
    text-shadow: 1px 1px 0.15vw #0d47a1;
  }
  .policeStanding {
    filter: drop-shadow(0 0 0.25rem #1565c0);
    text-shadow: 1px 1px 0.1vw #0d47a1;
  }

  /* --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é --- */
  #mainMenu {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #000a;
    border-radius: 1rem;
    padding: clamp(1rem, 4vw, 2rem) clamp(2rem, 8vw, 4rem);
    box-shadow: 0 0 1rem #FFD700;
    text-align: center;
    z-index: 1000;
    font-weight: 700;
    user-select: none;
    color: #FFD700;
    max-width: 90vw;
    width: 400px;
  }
  #versionMenu {
    position: absolute;
    bottom: 0.5rem;
    left: 0.5rem;
    font-size: 0.9rem;
    color: #FFD700;
    opacity: 0.7;
    user-select: none;
    pointer-events: none;
  }
  #menuLogo {
    font-weight: 900;
    margin-bottom: 1.5rem;
  }
  #menuLogo .text {
    font-size: clamp(1.5rem, 6vw, 2rem);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.4rem;
  }
  #menuLogo .nd {
    font-size: clamp(2rem, 5vw, 2.4rem);
  }
  #menuCharacter {
    font-size: 3.5rem;
    user-select: none;
    position: relative;
    text-shadow: 1px 1px 0.2vw #2e1b0c;
    animation: sway 2s ease-in-out infinite;
    transform-origin: center bottom;
    transform-style: preserve-3d;
    transform-box: fill-box;
    transform: scaleX(-1);
  }
  #menuCharacter #dog {
    position: absolute;
    top: 0;
    left: 0.6em;
    font-size: 0.625em;
    opacity: 0.7;
    animation: rideDog 1s ease-in-out infinite;
    transform-origin: center center;
  }
  #menuCharacter #helmet {
    position: absolute;
    top: 0.1em;
    left: 0.6em;
    width: 0.2em;
    height: 0.15em;
    background: gold;
    border-radius: 1rem 1rem 0 0;
    box-shadow: inset 0 -0.3rem 0.2rem #cc9f00;
    animation: rideDog 1s ease-in-out infinite;
  }
  #menuCharacter #scooter {
    position: relative;
    z-index: 1;
    animation: rideScooter 1s ease-in-out infinite;
    transform-origin: center bottom;
  }
  #mainMenu button {
    margin: 0.75rem 0;
    font-size: clamp(1rem, 4vw, 1.5rem);
    padding: 0.75rem 2rem;
    border: 2px solid #FFD700;
    border-radius: 0.75rem;
    background-color: transparent;
    color: #FFD700;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.3s, color 0.3s;
  }
  #mainMenu button:hover,
  #mainMenu button:focus {
    background-color: #FFD700;
    color: #000;
    outline: none;
  }
  
  /* –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ "–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É" */
  #becomeBtn {
    background-color: #dc2626 !important;
    color: #fff !important;
    border-color: #dc2626 !important;
  }
  #becomeBtn:hover,
  #becomeBtn:focus {
    background-color: #b91c1c !important;
    color: #fff !important;
    border-color: #b91c1c !important;
  }

  /* --- –ú–µ–Ω—é –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã --- */
  #gameOverMenu {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #000a;
    border-radius: 1rem;
    padding: clamp(1rem, 4vw, 2rem) clamp(2rem, 8vw, 4rem);
    box-shadow: 0 0 1rem #FFD700;
    text-align: center;
    z-index: 1100;
    font-size: clamp(1.2rem, 4vw, 1.5rem);
    font-weight: 700;
    user-select: none;
    color: #FFD700;
    display: none;
    max-width: 90vw;
    width: 320px;
  }
  #gameOverMenu button {
    margin: 0.75rem 0.5rem 0 0.5rem;
    font-size: clamp(1rem, 4vw, 1.25rem);
    padding: 0.5rem 1.5rem;
    border: 2px solid #FFD700;
    border-radius: 0.6rem;
    background-color: transparent;
    color: #FFD700;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
  }
  #gameOverMenu button:hover,
  #gameOverMenu button:focus {
    background-color: #FFD700;
    color: #000;
    outline: none;
  }

  /* --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–Ω–∏–∑—É --- */
  #info {
    position: fixed;
    bottom: 1vh;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255 255 255 / 0.85);
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-weight: 600;
    font-size: clamp(0.8rem, 3vw, 1.2rem);
    color: #3e2723;
    box-shadow: 0 0 0.5rem rgba(0,0,0,0.2);
    user-select: none;
    z-index: 20;
    max-width: 95vw;
    text-align: center;
    line-height: 1.2;
    display: none;
  }

  /* --- –ñ–∏–∑–Ω–∏ --- */
  #lives {
    position: fixed;
    top: 1vh;
    left: 1vw;
    font-size: clamp(1.5rem, 5vw, 2.5rem);
    user-select: none;
    z-index: 30;
    color: #FFD700;
    text-shadow: 0 0 0.4rem #FFA500;
    display: none;
  }

  /* --- –°–µ–Ω—Å–æ—Ä–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞ —Å–Ω–∏–∑—É --- */
  #touchControls {
    position: fixed;
    bottom: 1vh;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    padding: 0 1rem;
    z-index: 30;
    user-select: none;
    pointer-events: auto;
    max-width: 100vw;
    box-sizing: border-box;
    display: none;
  }
  .touchBtn {
    background: rgba(255 215 0, 0.7);
    border: none;
    border-radius: 1rem;
    width: clamp(3rem, 15vw, 5rem);
    height: clamp(3rem, 15vw, 5rem);
    font-size: clamp(1.5rem, 8vw, 3rem);
    color: #000;
    cursor: pointer;
    box-shadow: 0 0 1rem #FFD700;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background-color 0.3s;
  }
  .touchBtn:active {
    background: rgba(255 215 0, 0.9);
  }
  @media (min-width: 768px) {
    #touchControls {
      display: none !important;
    }
  }
  @media (max-width: 767px) {
    #touchControls {
      display: flex;
    }
  }

  /* --- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —Å –∂–µ–ª—Ç–æ–π —Ä–∞–º–∫–æ–π --- */
  #welcomeScreen {
    position: fixed;
    inset: 0;
    background: black;
    color: #FFD700;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    user-select: none;
    z-index: 3000;
    padding: 1rem;
    text-align: center;

    /* –ñ–µ–ª—Ç–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ä–∞–º–∫–∞ */
    box-sizing: border-box;
    border: 0.5vw solid #FFD700;
    border-radius: 2vw;
  }
  #welcomeScreen h1 {
    font-size: clamp(3rem, 15vw, 6rem);
    font-weight: 900;
    text-shadow: 0 0 1rem #FFD700, 0 0 2rem #FFA500;
    animation: blinkYellow 1s linear infinite alternate;
  }
  #welcomeScreen .subtitle {
    font-size: clamp(2rem, 8vw, 3rem);
    margin-top: 0.2em;
    font-weight: 700;
    text-shadow: 0 0 0.8rem #FFD700;
    animation: blinkYellow 1s linear infinite alternate;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.3rem;
  }
  #welcomeScreen .subtitle strong {
    font-weight: 900;
  }
  #welcomeCharacter {
    font-size: 3.5rem;
    user-select: none;
    position: relative;
    text-shadow: 1px 1px 0.2vw #2e1b0c;
    animation: sway 2s ease-in-out infinite;
    transform-origin: center bottom;
    transform-style: preserve-3d;
    transform-box: fill-box;
    transform: scaleX(-1);
  }
  #welcomeCharacter #dog {
    position: absolute;
    top: 0;
    left: 0.6em;
    font-size: 0.625em;
    opacity: 0.7;
    animation: rideDog 1s ease-in-out infinite;
    transform-origin: center center;
  }
  #welcomeCharacter #helmet {
    position: absolute;
    top: 0.1em;
    left: 0.6em;
    width: 0.2em;
    height: 0.15em;
    background: gold;
    border-radius: 1rem 1rem 0 0;
    box-shadow: inset 0 -0.3rem 0.2rem #cc9f00;
    animation: rideDog 1s ease-in-out infinite;
  }
  #welcomeCharacter #scooter {
    position: relative;
    z-index: 1;
    animation: rideScooter 1s ease-in-out infinite;
    transform-origin: center bottom;
  }
  @keyframes blinkYellow {
    0% { opacity: 1; }
    100% { opacity: 0.3; }
  }

  /* --- –≠–∫—Ä–∞–Ω –ü–û–¢–†–ê–ß–ï–ù–û --- */
  #gtaGameOverScreen {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    color: #ff0000;
    font-size: clamp(6rem, 20vw, 12rem);
    font-weight: 900;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    user-select: none;
    z-index: 4000;
    text-shadow:
      -2px -2px 0 #000,
      2px -2px 0 #000,
      -2px 2px 0 #000,
      2px 2px 0 #000;
    font-family: 'Impact', 'Arial Black', sans-serif;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    opacity: 0;
    animation: gtaFadeInOut 5s forwards;
    writing-mode: horizontal-tb;
    padding: 0 1rem;
    white-space: nowrap;
    overflow-wrap: normal;
    overflow-x: auto;
    display: none;
  }
  @media (max-width: 480px), (max-height: 700px) {
    #gtaGameOverScreen {
      font-size: clamp(3rem, 15vw, 6rem);
      letter-spacing: 0.05em;
      padding: 0 0.5rem;
      white-space: normal;
      overflow-x: visible;
      word-break: break-word;
    }
  }
  @keyframes gtaFadeInOut {
    0% {
      opacity: 0;
      transform: scale(0.7);
    }
    20% {
      opacity: 1;
      transform: scale(1);
    }
    80% {
      opacity: 1;
      transform: scale(1);
    }
    100% {
      opacity: 0;
      transform: scale(0.7);
    }
  }

  /* --- –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–µ–ø–æ—á–∫—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö --- */
  @media (max-width: 767px) {
    #helmet {
      top: 0.0em !important;
      height: 0.18em !important;
      width: 0.22em !important;
      box-shadow: inset 0 -0.35rem 0.25rem #cc9f00 !important;
    }
  }
</style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
<div id="welcomeScreen" role="alert" aria-live="assertive" aria-label="–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω –∏–≥—Ä—ã">
  <h1>–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞</h1>
  <div class="subtitle">
    <div id="welcomeCharacter" aria-label="–ü–µ—Ä—Å–æ–Ω–∞–∂ –∫—É—Ä—å–µ—Ä–∞ –∫–æ—Ä–≥–∏" role="img" style="display:inline-block; margin-left:0.3rem;">
      <img src="https://cdn.poehali.dev/files/d91aa39a-b906-481f-95ef-6c750cb6a76a.png" alt="–ö—É—Ä—å–µ—Ä –∫–æ—Ä–≥–∏" style="width:80px; height:80px; object-fit:contain; animation: bounce 2s infinite ease-in-out;" />
    </div>
  </div>
</div>

<!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
<div id="mainMenu" role="menu" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏–≥—Ä—ã" tabindex="0" style="display:none;">
  <div id="menuLogo" aria-label="–õ–æ–≥–æ—Ç–∏–ø –∏–≥—Ä—ã" style="margin-bottom: 1.5rem;">
    <div class="nd">–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞</div>
    <div class="text">
      <div id="menuCharacter" aria-label="–ü–µ—Ä—Å–æ–Ω–∞–∂ –∫—É—Ä—å–µ—Ä–∞ –∫–æ—Ä–≥–∏" role="img" style="display:inline-block; margin-left:0.3rem;">
        <img src="https://cdn.poehali.dev/files/d91aa39a-b906-481f-95ef-6c750cb6a76a.png" alt="–ö—É—Ä—å–µ—Ä –∫–æ—Ä–≥–∏" style="width:80px; height:80px; object-fit:contain; animation: bounce 2s infinite ease-in-out;" />
      </div>
    </div>
  </div>
  <button id="playBtn" role="menuitem">–ò–≥—Ä–∞—Ç—å</button>
  <button id="rulesBtn" role="menuitem">–ü—Ä–∞–≤–∏–ª–∞</button>
  <button id="becomeBtn" role="menuitem" style="background-color: #dc2626 !important; color: #fff !important; border-color: #dc2626 !important;">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
  <button id="exitBtn" role="menuitem">–í—ã—Ö–æ–¥ –∏–∑ –∏–≥—Ä—ã</button>

</div>

<!-- –ü—Ä–∞–≤–∏–ª–∞ -->
<div id="rulesDialog" role="dialog" aria-modal="true" aria-labelledby="rulesTitle" style="display:none; color:#fff; background:#000; padding:1rem; border-radius:1rem; max-width:600px; margin: 4vh auto; overflow-y:auto; max-height: 80vh; position: fixed; inset: 0; z-index: 2000;">
  <h2 id="rulesTitle" style="color:#FFD700; text-align:center; margin-bottom: 0.5rem;">–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h2>
  <ul style="line-height:1.5; font-size: 1.1rem; padding-left: 1.2rem;">
    <li>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫—É—Ä—å–µ—Ä–æ–º (üõµ) —Å—Ç—Ä–µ–ª–∫–∞–º–∏ ‚Üë –∏ ‚Üì –∏–ª–∏ –∫–∞—Å–∞–Ω–∏—è–º–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.</li>
    <li>–ö—É—Ä—å–µ—Ä –º–æ–∂–µ—Ç –ø–µ—Ä–µ–º–µ—â–∞—Ç—å—Å—è –ø–æ –ø—è—Ç–∏ –ø–æ–ª–æ—Å–∞–º –¥–≤–∏–∂–µ–Ω–∏—è, –º–µ–Ω—è—è –ø–æ–∑–∏—Ü–∏—é –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑.</li>
    <li>–°–æ–±–∏—Ä–∞–π—Ç–µ –µ–¥—É (üçï, üçî, üçü, üå≠, üçó, üåÆ) –¥–ª—è –æ—á–∫–æ–≤.</li>
    <li>–†–∞–∑–Ω—ã–µ –≤–∏–¥—ã —Ñ–∞—Å—Ç-—Ñ—É–¥–∞ –¥–∞—é—Ç —Ä–∞–∑–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤.</li>
    <li>–ü–æ—è–≤–ª—è—é—Ç—Å—è –∞–ø—Ç–µ—á–∫–∏ (ü©π), –∫–æ—Ç–æ—Ä—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –∂–∏–∑–Ω—å.</li>
    <li>–ò–∑–±–µ–≥–∞–π—Ç–µ –ø–µ—à–µ—Ö–æ–¥–æ–≤ –∏ –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏—Ö ‚Äî —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è –æ—Ç–Ω–∏–º–∞—é—Ç –∂–∏–∑–Ω–∏:</li>
    <ul style="font-size: 1rem; padding-left: 1rem;">
      <li>–°—Ç–æ—è—á–∏–π –ø–µ—à–µ—Ö–æ–¥ (üßç) –æ—Ç–Ω–∏–º–∞–µ—Ç 0.5 ‚ù§Ô∏è.</li>
      <li>–ò–¥—É—â–∏–µ –ø–µ—à–µ—Ö–æ–¥—ã (üö∂‚Äç‚ôÇÔ∏è, üö∂‚Äç‚ôÄÔ∏è) –æ—Ç–Ω–∏–º–∞—é—Ç 1 ‚ù§Ô∏è.</li>
      <li>–°—Ç–æ—è—á–∏–π –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π (üëÆ‚Äç‚ôÇÔ∏è) –æ—Ç–Ω–∏–º–∞–µ—Ç 1.5 ‚ù§Ô∏è.</li>
      <li>–ü–æ–ª–∏—Ü–µ–π—Å–∫–∞—è –º–∞—à–∏–Ω–∞ —Å –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–º (üöìüëÆ‚Äç‚ôÇÔ∏è) –æ—Ç–Ω–∏–º–∞–µ—Ç 2 ‚ù§Ô∏è.</li>
    </ul>
    <li>–ü–æ—è–≤–ª—è—é—Ç—Å—è –±–æ–Ω—É—Å—ã: —É—Å–∫–æ—Ä–µ–Ω–∏–µ (‚ö°Ô∏è) –∏ –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å (üõ°Ô∏è).</li>
    <li>–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —Å—Ç—Ä–µ–ª–∫–∏ –∏–ª–∏ —Å–µ–Ω—Å–æ—Ä–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ –ø–æ–ª–æ—Å–∞–º.</li>
    <li>–ò–≥—Ä–∞ —É—Å–ª–æ–∂–Ω—è–µ—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–æ–≤ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.</li>
    <li>–°–æ–±–∏—Ä–∞–π—Ç–µ –∫–æ–º–±–æ –µ–¥—ã –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—á–∫–æ–≤.</li>
    <li>–ò–≥—Ä–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –∂–∏–∑–Ω–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è.</li>
  </ul>
  <button id="closeRulesBtn" style="background:#FFD700; border:none; border-radius:1rem; padding:0.75rem 2rem; font-weight:700; cursor:pointer; color:#000; display:block; margin:1rem auto 0 auto;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div id="container" role="main" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ —Å –¥–æ—Ä–æ–∂–∫–æ–π –∏ –ª–µ—Å–æ–º" style="display:none;">

  <div class="city-strip" aria-hidden="true">
    <div class="scrolling-objects" aria-hidden="true" id="topObjects" tabindex="-1" aria-hidden="true">
      üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥
      üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥
    </div>
  </div>

  <div id="game" aria-label="–î–æ—Ä–æ–∂–∫–∞ —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º" style="position:relative;">
    <div class="lane lane0"></div>
    <div class="lane lane1"></div>
    <div class="lane lane2"></div>
    <div class="lane lane3"></div>
    <div class="lane lane4"></div>

    <div id="courier" aria-label="–ö—É—Ä—å–µ—Ä –∫–æ—Ä–≥–∏ –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ" role="img" aria-live="polite">
      <img src="https://cdn.poehali.dev/files/d91aa39a-b906-481f-95ef-6c750cb6a76a.png" alt="–ö—É—Ä—å–µ—Ä –∫–æ—Ä–≥–∏" style="width:100px; height:100px; object-fit:contain; animation: bounce 1s infinite ease-in-out; transform: scaleX(-1);" />
    </div>
    <div id="speechBubble" aria-live="polite" role="alert"></div>
  </div>

  <div class="city-strip" aria-hidden="true">
    <div class="scrolling-objects" aria-hidden="true" id="bottomObjects" tabindex="-1" aria-hidden="true">
      üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤
      üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤üå≥üå≤
    </div>
  </div>



</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
<div id="info" aria-live="polite" style="display:none;">
  –û—á–∫–∏: <span id="score">0</span> | –ñ–∏–∑–Ω–∏: <span id="lifeCount">3</span> | –í—Ä–µ–º—è: <span id="timer">0</span> —Å–µ–∫<br>
  –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å—Ç—Ä–µ–ª–∫–∞–º–∏ ‚Üë –∏ ‚Üì, —á—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ –ø–æ–ª–æ—Å–∞–º.
</div>

<!-- –ñ–∏–∑–Ω–∏ -->
<div id="lives" aria-label="–ñ–∏–∑–Ω–∏ –∏–≥—Ä–æ–∫–∞" role="img" aria-live="polite" style="display:none;">
  ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è
</div>

<!-- –ú–µ–Ω—é –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã -->
<div id="gameOverMenu" role="dialog" aria-modal="true" aria-labelledby="gameOverTitle" style="display:none;">
  <div id="gameOverTitle" style="margin-bottom: 12px;">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</div>
  <div>–í–∞—à —Å—á—ë—Ç: <span id="finalScore">0</span></div>
  <button id="restartBtn">–ó–∞–Ω–æ–≤–æ</button>
  <button id="toMenuBtn">–í –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω –ü–û–¢–†–ê–ß–ï–ù–û -->
<div id="gtaGameOverScreen" role="alert" aria-live="assertive" aria-label="–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞ - –ü–æ—Ç—Ä–∞—á–µ–Ω–æ" style="display:none;">
  –ü–û–¢–†–ê–ß–ï–ù–û
</div>

<!-- –°–µ–Ω—Å–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
<div id="touchControls" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞" role="group" style="display:none;">
  <button id="btnUp" aria-label="–í–≤–µ—Ä—Ö" class="touchBtn">‚ñ≤</button>
  <button id="btnDown" aria-label="–í–Ω–∏–∑" class="touchBtn">‚ñº</button>
</div>

<script>
(() => {
  // –≠–ª–µ–º–µ–Ω—Ç—ã
  const welcomeScreen = document.getElementById('welcomeScreen');
  const mainMenu = document.getElementById('mainMenu');
  const rulesDialog = document.getElementById('rulesDialog');
  const gameOverMenu = document.getElementById('gameOverMenu');
  const container = document.getElementById('container');
  const info = document.getElementById('info');
  const courier = document.getElementById('courier');
  const scoreElem = document.getElementById('score');
  const finalScoreElem = document.getElementById('finalScore');
  const livesElem = document.getElementById('lives');
  const lifeCountElem = document.getElementById('lifeCount');
  const btnUp = document.getElementById('btnUp');
  const btnDown = document.getElementById('btnDown');
  const gtaGameOverScreen = document.getElementById('gtaGameOverScreen');
  const touchControls = document.getElementById('touchControls');
  const playBtn = document.getElementById('playBtn');
  const rulesBtn = document.getElementById('rulesBtn');
  const exitBtn = document.getElementById('exitBtn');
  const closeRulesBtn = document.getElementById('closeRulesBtn');
  const restartBtn = document.getElementById('restartBtn');
  const toMenuBtn = document.getElementById('toMenuBtn');
  const becomeBtn = document.getElementById('becomeBtn');
  const game = document.getElementById('game');
  const speechBubble = document.getElementById('speechBubble');
  const lanes = document.querySelectorAll('.lane');

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–ø–æ —à–∏—Ä–∏–Ω–µ —ç–∫—Ä–∞–Ω–∞)
  const isMobile = window.innerWidth <= 767;

  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  let score = 0;
  let lives = 3;
  let gameOverFlag = false;
  let paused = false;
  let gameTime = 0;
  let comboCount = 0;
  let comboTimeout = null;
  const maxSpeedX = isMobile ? 7 : 12;
  let speedX = isMobile ? 3 : 4;

  let lanePositions = [];
  let courierLane = 2;
  let courierCurrentY = 0;
  let courierTargetLane = 2;

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–µ–º
  let movingUp = false;
  let movingDown = false;

  let pedestrians = [];
  let standingPeds = [];
  let policeStandings = [];
  let foods = [];
  let medkits = [];
  let bonuses = [];
  let policeCars = [];

  let pedestrianSpawnTimer;
  let standingPedSpawnTimer;
  let policeStandingSpawnTimer;
  let foodSpawnTimer;
  let medkitSpawnTimer;
  let bonusSpawnTimer;
  let policeCarSpawnTimer;
  let gameLoopId;
  let lastFrameTime = 0;
  let timerInterval;

  let shieldActive = false;
  let speedBoostActive = false;
  let speedBoostTimeout = null;
  let shieldTimeout = null;

  const pedestrianPhrases = [
    "–û–ø–∞, –∂–∏–≤—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ!",
    "–ü–µ—à–µ—Ö–æ–¥—ã! –í—Ä—É–±–∞–π —Ä–µ–∂–∏–º –Ω–∏–Ω–¥–∑—è!",
    "–õ—é–¥–∏ –∏–¥—É—Ç ‚Äî –≥–∞–∑ –≤ –ø–æ–ª, –±—Ä–∞—Ç!",
    "–°–º–æ—Ç—Ä–∏, —Ç—É—Ç —Ç–æ–ª–ø–∞! –í–∂—É—Ö ‚Äî –∏ –º—ã —É–∂–µ –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ!",
    "–ü–µ—à–µ—Ö–æ–¥—ã ‚Äî –≥–ª–∞–≤–Ω—ã–µ —Ç–æ—Ä–º–æ–∑–∞ –∂–∏–∑–Ω–∏!",
    "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ, —Ö–æ–¥—è—á–∏–µ –∫–µ–≥–ª–∏!",
    "–ü–µ—à–µ—Ö–æ–¥—ã! –í—Ä–µ–º—è –¥–ª—è —Ç–∞–Ω—Ü–µ–≤ –Ω–∞ —Å–∫—É—Ç–µ—Ä–µ!",
    "–õ—é–¥–∏ –∏–¥—É—Ç, –∫–∞–∫ –±—É–¥—Ç–æ —è –∏–º –¥–æ–ª–∂–µ–Ω!",
    "–ü–µ—à–µ—Ö–æ–¥—ã ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–≤–µ—Å—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å!",
    "–•–∞! –ü–µ—à–µ—Ö–æ–¥—ã, –≤—ã –º–µ–Ω—è –Ω–µ –¥–æ–≥–æ–Ω–∏—Ç–µ!",
    "–ü–µ—à–µ—Ö–æ–¥—ã ‚Äî –≥–ª–∞–≤–Ω–∞—è —É–≥—Ä–æ–∑–∞ –º–æ–µ–º—É —Å—Ç–∏–ª—é!",
    "–ñ–∏–≤—ã–µ –ø—Ä–æ–±–∫–∏ –Ω–∞ –∫–æ–ª–µ—Å–∞—Ö!",
    "–ü–µ—à–µ—Ö–æ–¥—ã –∏–¥—É—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, –≤—Ä–µ–º—è –¥–ª—è —Ç—Ä—é–∫–æ–≤!",
    "–ü–µ—à–µ—Ö–æ–¥—ã ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∂–∏–≤—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–¥–æ –æ–±—ä–µ—Ö–∞—Ç—å!",
    "–ü–µ—à–µ—Ö–æ–¥—ã! –í—Ä–µ–º—è –¥–ª—è –ø–∞—Ä–∫—É—Ä–∞ –Ω–∞ —Å–∫—É—Ç–µ—Ä–µ!"
  ];
  const policePhrases = [
    "–û–ø–∞, –º—É—Å–æ—Ä–∞ –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ! –í–∂—É—Ö ‚Äî –∏ –Ω–µ—Ç –º–µ–Ω—è!",
    "–ö–æ–ø—ã –µ–¥—É—Ç, –ø–æ—Ä–∞ –¥–µ–ª–∞—Ç—å –Ω–æ–≥–∏, –∫–∞–∫ –≤ —Ñ–∏–ª—å–º–∞—Ö!",
    "–ú—É—Å–æ—Ä–∞! –í—Ä—É–±–∞–π —Ç—É—Ä–±–æ, –Ω–µ —Ç–æ—Ä–º–æ–∑–∏!",
    "–ü–æ–ª–∏—Ü–∏—è –Ω–∞ —Ö–≤–æ—Å—Ç–µ, –Ω–∞–¥–æ —É–ª–∏–∑–Ω—É—Ç—å –∫–∞–∫ –Ω–∏–Ω–¥–∑—è!",
    "–í–æ—Ç –∏ –º—É—Å–æ—Ä–∞, –≤—Ä–µ–º—è –¥–ª—è —Å—É–ø–µ—Ä-–º–∞–Ω—ë–≤—Ä–∞!",
    "–ö–æ–ø—ã –∏–¥—É—Ç ‚Äî –ø—Ä–∏—Ç–≤–æ—Ä—é—Å—å –Ω–µ–≤–∏–¥–∏–º–∫–æ–π!",
    "–ú—É—Å–æ—Ä–∞ –±–ª–∏–∑–∫–æ, –ø–æ—Ä–∞ –≤–∫–ª—é—á–∞—Ç—å —Ä–µ–∂–∏–º ¬´–ø—Ä–∏–∑—Ä–∞–∫¬ª!",
    "–ü–æ–ª–∏—Ü–∏—è –≤ –∑–æ–Ω–µ, –¥–∞–≤–∞–π-–∫–∞ –ø–æ-–±—ã—Å—Ç—Ä–µ–µ!",
    "–ö–æ–ø—ã –Ω–∞ —Ö–≤–æ—Å—Ç–µ ‚Äî –≤–∫–ª—é—á–∞—é —Ä–µ–∂–∏–º ¬´–°—Ç—å—é¬ª!",
    "–ú—É—Å–æ—Ä–∞ –Ω–∞ –¥–æ—Ä–æ–≥–µ? –ü–æ—à–ª–∏, —è –∏—Ö –æ–±–≥–æ–Ω—é!",
    "–ü–æ–ª–∏—Ü–∏—è –≤ —Ä–∞–¥–∏—É—Å–µ ‚Äî –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º ¬´Stuey.Go¬ª!",
    "–ú—É—Å–æ—Ä–∞ –∏–¥—É—Ç, –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –≤–∏–¥, —á—Ç–æ —è –ø—Ä–æ—Å—Ç–æ –ø–∏—Ü—Ü–∞!",
    "–ö–æ–ø—ã –Ω–∞ —Ö–≤–æ—Å—Ç–µ, –Ω–∞–¥–æ —Å—Ä–æ—á–Ω–æ –Ω–∞ –ø–µ—Ä–µ–∫—É—Å!",
    "–ü–æ–ª–∏—Ü–∏—è ‚Äî –Ω–µ –ø–æ–≤–æ–¥ –¥–ª—è –ø–∞–Ω–∏–∫–∏, –∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏!",
    "–ú—É—Å–æ—Ä–∞ –≤ –∑–æ–Ω–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏, –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º ¬´–Ω–µ–≤–∏–¥–∏–º–∫–∞¬ª!"
  ];

  let lastSpeechTime = 0;
  const speechCooldown = 4000; // 4 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É —Ä–µ—á–∞–º–∏

  // –ó–∞–¥–µ—Ä–∂–∫–∞ —Å–º–µ–Ω—ã –ø–æ–ª–æ—Å—ã –ø—Ä–∏ —É–¥–µ—Ä–∂–∞–Ω–∏–∏
  let moveCooldown = 0;

  // –î–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ—á–∏
  let speechTimeout = null;

  // --- –§—É–Ω–∫—Ü–∏–∏ ---

  function recalcLanes() {
    lanePositions = [];
    const laneCount = 5;
    const gameRect = game.getBoundingClientRect();
    for(let i=0; i<laneCount; i++) {
      lanePositions.push(gameRect.top + gameRect.height * ((i + 0.5) / laneCount));
    }
    courierCurrentY = lanePositions[courierLane] - courier.offsetHeight / 2;
    courier.style.top = courierCurrentY + 'px';

    [...pedestrians, ...standingPeds, ...policeStandings, ...foods, ...medkits, ...bonuses, ...policeCars].forEach(obj => {
      const lane = obj.lane;
      if (lanePositions[lane]) {
        obj.elem.style.top = (lanePositions[lane] - obj.elem.offsetHeight / 2) + 'px';
      }
    });
  }

  function updateCourierPositionSmooth() {
    const targetY = lanePositions[courierTargetLane] - courier.offsetHeight / 2;
    let diff = targetY - courierCurrentY;
    if (Math.abs(diff) < 1) {
      courierCurrentY = targetY;
      courierLane = courierTargetLane;
    } else {
      courierCurrentY += diff * 0.25;
    }
    courier.style.top = courierCurrentY + 'px';
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
  function createPedestrian() {
    if (gameOverFlag) return;
    const ped = document.createElement('div');
    ped.classList.add('pedestrian');
    const lane = Math.floor(Math.random() * 5);
    ped.dataset.lane = lane;
    ped.style.top = (lanePositions[lane] - 24) + 'px';
    ped.style.left = window.innerWidth + 'px';
    const pedestrianEmojis = ['üö∂‚Äç‚ôÇÔ∏è', 'üö∂‚Äç‚ôÄÔ∏è'];
    ped.textContent = pedestrianEmojis[Math.floor(Math.random() * pedestrianEmojis.length)];
    game.appendChild(ped);
    const speedFactor = 0.8 + Math.random() * 0.4;
    pedestrians.push({ elem: ped, x: window.innerWidth, lane, speed: speedX * speedFactor });
  }
  function createStandingPedestrian() {
    if (gameOverFlag) return;
    const ped = document.createElement('div');
    ped.classList.add('pedestrian');
    const lane = Math.floor(Math.random() * 5);
    ped.dataset.lane = lane;
    ped.style.top = (lanePositions[lane] - 24) + 'px';
    ped.style.left = window.innerWidth + 'px';
    ped.textContent = 'üßç';
    game.appendChild(ped);
    standingPeds.push({ elem: ped, x: window.innerWidth, lane, speed: speedX * 0.5 });
  }
  function createPoliceStanding() {
    if (gameOverFlag) return;
    const cop = document.createElement('div');
    cop.classList.add('policeStanding');
    const lane = Math.floor(Math.random() * 5);
    cop.dataset.lane = lane;
    cop.style.top = (lanePositions[lane] - 24) + 'px';
    cop.style.left = window.innerWidth + 'px';
    cop.textContent = 'üëÆ‚Äç‚ôÇÔ∏è';
    game.appendChild(cop);
    policeStandings.push({ elem: cop, x: window.innerWidth, lane, speed: speedX * 0.5 });
  }
  function createFood() {
    if (gameOverFlag) return;
    const food = document.createElement('div');
    food.classList.add('food');
    const lane = Math.floor(Math.random() * 5);
    food.dataset.lane = lane;
    food.style.top = (lanePositions[lane] - 24) + 'px';
    food.style.left = window.innerWidth + 'px';
    const foodItems = [
      { emoji: 'üçï', points: 10 },
      { emoji: 'üçî', points: 8 },
      { emoji: 'üçü', points: 7 },
      { emoji: 'üå≠', points: 6 },
      { emoji: 'üçó', points: 9 },
      { emoji: 'üåÆ', points: 11 }
    ];
    const item = foodItems[Math.floor(Math.random() * foodItems.length)];
    food.textContent = item.emoji;
    game.appendChild(food);
    foods.push({ elem: food, x: window.innerWidth, lane, points: item.points, speed: speedX });
  }
  function createMedkit() {
    if (gameOverFlag) return;
    const medkit = document.createElement('div');
    medkit.classList.add('medkit');
    const lane = Math.floor(Math.random() * 5);
    medkit.dataset.lane = lane;
    medkit.style.top = (lanePositions[lane] - 24) + 'px';
    medkit.style.left = window.innerWidth + 'px';
    medkit.textContent = 'ü©π';
    game.appendChild(medkit);
    medkits.push({ elem: medkit, x: window.innerWidth, lane, speed: speedX });
  }
  function createBonus() {
    if (gameOverFlag) return;
    const bonus = document.createElement('div');
    bonus.classList.add('bonus');
    const lane = Math.floor(Math.random() * 5);
    bonus.dataset.lane = lane;
    bonus.style.top = (lanePositions[lane] - 24) + 'px';
    bonus.style.left = window.innerWidth + 'px';
    const bonusesArr = ['‚ö°Ô∏è', 'üõ°Ô∏è'];
    bonus.textContent = bonusesArr[Math.floor(Math.random() * bonusesArr.length)];
    game.appendChild(bonus);
    bonuses.push({ elem: bonus, x: window.innerWidth, lane, speed: speedX, type: bonus.textContent });
  }
  function createPoliceCar() {
    if (gameOverFlag) return;
    const car = document.createElement('div');
    car.classList.add('policeCar');
    const lane = Math.floor(Math.random() * 5);
    car.dataset.lane = lane;
    car.style.top = (lanePositions[lane] - 24) + 'px';
    car.style.left = window.innerWidth + 'px';
    car.textContent = 'üöìüëÆ‚Äç‚ôÇÔ∏è';
    game.appendChild(car);
    policeCars.push({ elem: car, x: window.innerWidth, lane, speed: speedX * 1.5 });
  }

  function updateObjects(delta) {
    // –í—Å–µ –æ–±—ä–µ–∫—Ç—ã –¥–≤–∏–∂—É—Ç—Å—è –≤–ª–µ–≤–æ —Å —É—á–µ—Ç–æ–º delta –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏
    function moveArray(arr) {
      for(let i=arr.length-1; i>=0; i--) {
        let obj = arr[i];
        obj.x -= obj.speed * delta;
        if (obj.x < -50) {
          obj.elem.remove();
          arr.splice(i,1);
        } else {
          obj.elem.style.left = obj.x + 'px';
        }
      }
    }
    moveArray(pedestrians);
    moveArray(standingPeds);
    moveArray(policeStandings);
    moveArray(foods);
    moveArray(medkits);
    moveArray(bonuses);
    moveArray(policeCars);
  }

  function checkCollisions() {
    if (gameOverFlag) return;

    const courierRect = courier.getBoundingClientRect();

    function isCollide(r1, r2) {
      return !(r2.left > r1.right || 
               r2.right < r1.left || 
               r2.top > r1.bottom ||
               r2.bottom < r1.top);
    }

    for(let i=pedestrians.length-1; i>=0; i--) {
      let p = pedestrians[i];
      if (p.lane === courierLane) {
        const r = p.elem.getBoundingClientRect();
        if (isCollide(courierRect, r)) {
          if (!shieldActive) {
            loseLife(1);
            showSpeechRandom(pedestrianPhrases);
            playSound('hit');
          }
          p.elem.remove();
          pedestrians.splice(i, 1);
          return;
        }
      }
    }
    for(let i=standingPeds.length-1; i>=0; i--) {
      let p = standingPeds[i];
      if (p.lane === courierLane) {
        const r = p.elem.getBoundingClientRect();
        if (isCollide(courierRect, r)) {
          if (!shieldActive) {
            loseLife(0.5);
            showSpeechRandom(pedestrianPhrases);
            playSound('hit');
          }
          p.elem.remove();
          standingPeds.splice(i, 1);
          return;
        }
      }
    }
    for(let i=policeStandings.length-1; i>=0; i--) {
      let p = policeStandings[i];
      if (p.lane === courierLane) {
        const r = p.elem.getBoundingClientRect();
        if (isCollide(courierRect, r)) {
          if (!shieldActive) {
            loseLife(1.5);
            showSpeechRandom(policePhrases);
            playSound('hit');
          }
          p.elem.remove();
          policeStandings.splice(i, 1);
          return;
        }
      }
    }
    for(let i=policeCars.length-1; i>=0; i--) {
      let p = policeCars[i];
      if (p.lane === courierLane) {
        const r = p.elem.getBoundingClientRect();
        if (isCollide(courierRect, r)) {
          if (!shieldActive) {
            loseLife(2);
            showSpeechRandom(policePhrases);
            playSound('hit');
          }
          p.elem.remove();
          policeCars.splice(i, 1);
          return;
        }
      }
    }
    for(let i=foods.length-1; i>=0; i--) {
      let f = foods[i];
      if (f.lane === courierLane) {
        const r = f.elem.getBoundingClientRect();
        if (isCollide(courierRect, r)) {
          score += f.points;
          comboCount++;
          if (comboTimeout) clearTimeout(comboTimeout);
          comboTimeout = setTimeout(() => {
            comboCount = 0;
          }, 3000);
          if (comboCount > 1) {
            score += comboCount * 2;
          }
          updateScoreDisplay();
          f.elem.remove();
          foods.splice(i, 1);
          playSound('eat');
          return;
        }
      }
    }
    for(let i=medkits.length-1; i>=0; i--) {
      let m = medkits[i];
      if (m.lane === courierLane) {
        const r = m.elem.getBoundingClientRect();
        if (isCollide(courierRect, r)) {
          if (lives < 3) {
            lives = Math.min(3, lives + 1);
            updateLivesDisplay();
            playSound('medkit');
          }
          m.elem.remove();
          medkits.splice(i, 1);
          return;
        }
      }
    }
    for(let i=bonuses.length-1; i>=0; i--) {
      let b = bonuses[i];
      if (b.lane === courierLane) {
        const r = b.elem.getBoundingClientRect();
        if (isCollide(courierRect, r)) {
          if (b.type === '‚ö°Ô∏è') {
            activateSpeedBoost();
            playSound('bonus');
          } else if (b.type === 'üõ°Ô∏è') {
            activateShield();
            playSound('bonus');
          }
          b.elem.remove();
          bonuses.splice(i, 1);
          return;
        }
      }
    }
  }

  function loseLife(amount) {
    if (shieldActive) return;
    lives -= amount;
    if (lives < 0) lives = 0;
    updateLivesDisplay();
    if (lives <= 0) {
      gameOver();
    }
  }

  function updateScoreDisplay() {
    scoreElem.textContent = Math.floor(score);
  }
  function updateLivesDisplay() {
    lifeCountElem.textContent = lives.toFixed(1);
    const fullHearts = Math.floor(lives);
    const halfHeart = (lives % 1) >= 0.5 ? 1 : 0;
    let heartsStr = '';
    for(let i=0; i<fullHearts; i++) heartsStr += '‚ù§Ô∏è';
    if (halfHeart) heartsStr += 'üíî';
    livesElem.textContent = heartsStr || 'üíÄ';
  }

  function showSpeech(text) {
    if (speechTimeout) clearTimeout(speechTimeout);
    speechBubble.textContent = text;
    speechBubble.style.opacity = '1';
    const rect = courier.getBoundingClientRect();
    speechBubble.style.top = (rect.top - speechBubble.offsetHeight - 5) + 'px';
    speechBubble.style.left = (rect.left + courier.offsetWidth + 10) + 'px';

    speechTimeout = setTimeout(() => {
      speechBubble.style.opacity = '0';
    }, 3000);
  }
  function showSpeechRandom(arr) {
    const text = arr[Math.floor(Math.random() * arr.length)];
    showSpeech(text);
  }

  function activateSpeedBoost() {
    if (speedBoostActive) {
      clearTimeout(speedBoostTimeout);
    } else {
      speedBoostActive = true;
      speedX = Math.min(maxSpeedX, speedX + (isMobile ? 2 : 4));
      updateDashSpeed();
      showSpeech('‚ö°Ô∏è –£—Å–∫–æ—Ä–µ–Ω–∏–µ!');
    }
    speedBoostTimeout = setTimeout(() => {
      speedBoostActive = false;
      speedX = Math.max(isMobile ? 3 : 4, speedX - (isMobile ? 2 : 4));
      updateDashSpeed();
      showSpeech('‚ö°Ô∏è –£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ');
    }, 7000);
  }
  function activateShield() {
    if (shieldActive) {
      clearTimeout(shieldTimeout);
    } else {
      shieldActive = true;
      showSpeech('üõ°Ô∏è –©–∏—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');
      courier.style.filter = 'drop-shadow(0 0 10px #64b5f6)';
    }
    shieldTimeout = setTimeout(() => {
      shieldActive = false;
      showSpeech('üõ°Ô∏è –©–∏—Ç –∏—Å—á–µ–∑');
      courier.style.filter = '';
    }, 7000);
  }

  // –°–∏—Å—Ç–µ–º–∞ –∑–≤—É–∫–æ–≤
  let audioContext;
  let backgroundMusicGain;
  let backgroundMusicOscillator;
  let isBackgroundMusicPlaying = false;
  
  const melody = [
    // –ë–æ–ª–µ–µ —ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è –º–µ–ª–æ–¥–∏—è –¥–ª—è –∏–≥—Ä—ã –∫—É—Ä—å–µ—Ä–∞
    440.00, // A4
    523.25, // C5  
    659.25, // E5
    783.99, // G5
    880.00, // A5
    783.99, // G5
    659.25, // E5
    698.46, // F5
    659.25, // E5
    587.33, // D5
    523.25, // C5
    587.33, // D5
    659.25, // E5
    523.25, // C5
    440.00, // A4
    493.88, // B4
  ];
  
  const bassLine = [
    // –ë–∞—Å–æ–≤–∞—è –ª–∏–Ω–∏—è –¥–ª—è —Ä–∏—Ç–º–∞
    220.00, // A3
    261.63, // C4
    329.63, // E4
    392.00, // G4
    220.00, // A3
    261.63, // C4
    329.63, // E4
    349.23, // F4
  ];
  let currentNoteIndex = 0;
  let nextNoteTime = 0;
  let musicScheduler;
  
  function initAudioContext() {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      backgroundMusicGain = audioContext.createGain();
      backgroundMusicGain.connect(audioContext.destination);
      backgroundMusicGain.gain.value = 0.15; // –ß—É—Ç—å –≥—Ä–æ–º—á–µ –¥–ª—è –±–æ–ª—å—à–µ–π –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏
    }
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
  }
  
  function createSound(frequency, duration, type = 'sine', volume = 0.3) {
    if (!audioContext) initAudioContext();
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = type;
    
    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
    gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
  }
  
  function playBackgroundMusic() {
    if (!audioContext || isBackgroundMusicPlaying) return;
    initAudioContext();
    
    isBackgroundMusicPlaying = true;
    nextNoteTime = audioContext.currentTime;
    currentNoteIndex = 0;
    
    function scheduleNote() {
      if (!isBackgroundMusicPlaying) return;
      
      while (nextNoteTime < audioContext.currentTime + 0.1) {
        const oscillator = audioContext.createOscillator();
        const noteGain = audioContext.createGain();
        
        oscillator.connect(noteGain);
        noteGain.connect(backgroundMusicGain);
        
        const frequency = melody[currentNoteIndex % melody.length];
        oscillator.frequency.value = frequency;
        oscillator.type = 'triangle'; // –ë–æ–ª–µ–µ –º—è–≥–∫–∏–π –∑–≤—É–∫
        
        noteGain.gain.setValueAtTime(0, nextNoteTime);
        noteGain.gain.linearRampToValueAtTime(0.12, nextNoteTime + 0.05);
        noteGain.gain.exponentialRampToValueAtTime(0.01, nextNoteTime + 0.4);
        
        oscillator.start(nextNoteTime);
        oscillator.stop(nextNoteTime + 0.5);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≥–∞—Ä–º–æ–Ω–∏—é (–æ–∫—Ç–∞–≤–∞ –≤—ã—à–µ)
        if (currentNoteIndex % 2 === 0) {
          const harmonyOsc = audioContext.createOscillator();
          const harmonyGain = audioContext.createGain();
          
          harmonyOsc.connect(harmonyGain);
          harmonyGain.connect(backgroundMusicGain);
          
          harmonyOsc.frequency.value = frequency * 2; // –û–∫—Ç–∞–≤–∞ –≤—ã—à–µ
          harmonyOsc.type = 'sine';
          
          harmonyGain.gain.setValueAtTime(0, nextNoteTime);
          harmonyGain.gain.linearRampToValueAtTime(0.06, nextNoteTime + 0.05);
          harmonyGain.gain.exponentialRampToValueAtTime(0.01, nextNoteTime + 0.3);
          
          harmonyOsc.start(nextNoteTime);
          harmonyOsc.stop(nextNoteTime + 0.4);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –±–∞—Å–æ–≤—É—é –ª–∏–Ω–∏—é –∫–∞–∂–¥—ã–µ 4 –Ω–æ—Ç—ã
        if (currentNoteIndex % 4 === 0) {
          const bassOsc = audioContext.createOscillator();
          const bassGain = audioContext.createGain();
          
          bassOsc.connect(bassGain);
          bassGain.connect(backgroundMusicGain);
          
          const bassNote = bassLine[Math.floor(currentNoteIndex / 4) % bassLine.length];
          bassOsc.frequency.value = bassNote;
          bassOsc.type = 'square';
          
          bassGain.gain.setValueAtTime(0, nextNoteTime);
          bassGain.gain.linearRampToValueAtTime(0.08, nextNoteTime + 0.02);
          bassGain.gain.exponentialRampToValueAtTime(0.01, nextNoteTime + 0.6);
          
          bassOsc.start(nextNoteTime);
          bassOsc.stop(nextNoteTime + 0.7);
        }
        
        const secondsPerBeat = 60.0 / 140; // 140 BPM - –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–π —Ç–µ–º–ø
        nextNoteTime += secondsPerBeat;
        currentNoteIndex++;
      }
      
      if (isBackgroundMusicPlaying) {
        musicScheduler = setTimeout(scheduleNote, 25);
      }
    }
    
    scheduleNote();
  }
  
  function stopBackgroundMusic() {
    isBackgroundMusicPlaying = false;
    if (musicScheduler) {
      clearTimeout(musicScheduler);
      musicScheduler = null;
    }
  }
  
  function playSound(name) {
    if (!audioContext) initAudioContext();
    
    try {
      switch (name) {
        case 'eat':
          createSound(800, 0.15, 'square', 0.4);
          setTimeout(() => createSound(1200, 0.1, 'sine', 0.3), 50);
          break;
        case 'medkit':
          createSound(523, 0.2, 'sine', 0.4);
          setTimeout(() => createSound(659, 0.2, 'sine', 0.4), 100);
          setTimeout(() => createSound(784, 0.3, 'sine', 0.4), 200);
          break;
        case 'hit':
          createSound(200, 0.3, 'sawtooth', 0.5);
          break;
        case 'gameOver':
          createSound(440, 0.3, 'sawtooth', 0.6);
          setTimeout(() => createSound(330, 0.3, 'sawtooth', 0.6), 300);
          setTimeout(() => createSound(262, 0.5, 'sawtooth', 0.6), 600);
          break;
        case 'bonus':
          createSound(1200, 0.1, 'sine', 0.4);
          setTimeout(() => createSound(1600, 0.15, 'triangle', 0.3), 50);
          break;
        default:
          createSound(440, 0.1, 'sine', 0.3);
      }
    } catch (error) {
      console.warn('Sound playback failed:', error);
    }
  }

  function startSpawning() {
    pedestrianSpawnTimer = setInterval(createPedestrian, 2200);
    standingPedSpawnTimer = setInterval(createStandingPedestrian, 2500);
    policeStandingSpawnTimer = setInterval(createPoliceStanding, 12000);
    foodSpawnTimer = setInterval(createFood, 1800);
    medkitSpawnTimer = setInterval(createMedkit, 9000);
    bonusSpawnTimer = setInterval(createBonus, 15000);
    policeCarSpawnTimer = setInterval(createPoliceCar, 25000);
  }
  function stopSpawning() {
    clearInterval(pedestrianSpawnTimer);
    clearInterval(standingPedSpawnTimer);
    clearInterval(policeStandingSpawnTimer);
    clearInterval(foodSpawnTimer);
    clearInterval(medkitSpawnTimer);
    clearInterval(bonusSpawnTimer);
    clearInterval(policeCarSpawnTimer);
  }

  function checkUpcomingThreat() {
    if (gameOverFlag) return;

    const now = Date.now();
    if (now - lastSpeechTime < speechCooldown) return;

    const courierRect = courier.getBoundingClientRect();
    const thresholdMin = courierRect.right + 50;
    const thresholdMax = courierRect.right + 300;

    for (const p of pedestrians) {
      const pRect = p.elem.getBoundingClientRect();
      if (p.lane === courierLane && pRect.left >= thresholdMin && pRect.left <= thresholdMax) {
        showSpeechRandom(pedestrianPhrases);
        lastSpeechTime = now;
        return;
      }
    }
    for (const p of standingPeds) {
      const pRect = p.elem.getBoundingClientRect();
      if (p.lane === courierLane && pRect.left >= thresholdMin && pRect.left <= thresholdMax) {
        showSpeechRandom(pedestrianPhrases);
        lastSpeechTime = now;
        return;
      }
    }
    for (const p of policeStandings) {
      const pRect = p.elem.getBoundingClientRect();
      if (p.lane === courierLane && pRect.left >= thresholdMin && pRect.left <= thresholdMax) {
        showSpeechRandom(policePhrases);
        lastSpeechTime = now;
        return;
      }
    }
    for (const p of policeCars) {
      const pRect = p.elem.getBoundingClientRect();
      if (p.lane === courierLane && pRect.left >= thresholdMin && pRect.left <= thresholdMax) {
        showSpeechRandom(policePhrases);
        lastSpeechTime = now;
        return;
      }
    }
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ–ª–æ—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
  function updateDashSpeed() {
    // speedX –æ—Ç 3/4 –¥–æ maxSpeedX -> duration –æ—Ç 1.5 –¥–æ 0.5 —Å–µ–∫
    const minDuration = 0.5;
    const maxDuration = 1.5;
    const baseSpeed = isMobile ? 3 : 4;
    const duration = maxDuration - ((speedX - baseSpeed) / (maxSpeedX - baseSpeed)) * (maxDuration - minDuration);
    lanes.forEach(lane => {
      lane.style.animationDuration = duration + 's';
    });
  }

  function gameTick(timestamp) {
    if (!lastFrameTime) lastFrameTime = timestamp;
    const delta = (timestamp - lastFrameTime) / 16.67; // –ø—Ä–∏–º–µ—Ä–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤ (1 –∫–∞–¥—Ä = 16.67–º—Å)
    lastFrameTime = timestamp;

    if (!paused && !gameOverFlag) {
      checkUpcomingThreat();

      if (moveCooldown > 0) {
        moveCooldown -= delta * 16.67;
      }
      if (moveCooldown <= 0) {
        if (movingUp && courierTargetLane > 0) {
          courierTargetLane--;
          moveCooldown = 200;
        } else if (movingDown && courierTargetLane < 4) {
          courierTargetLane++;
          moveCooldown = 200;
        }
      }

      updateCourierPositionSmooth();

      updateObjects(delta);

      checkCollisions();

      if (gameTime % 10 === 0 && speedX < maxSpeedX) {
        speedX += 0.015; // —á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Ä–æ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
        if (speedX > maxSpeedX) speedX = maxSpeedX;
        updateDashSpeed();
      }
    }

    requestAnimationFrame(gameTick);
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      gameTime++;
      document.getElementById('timer').textContent = gameTime;
    }, 1000);
  }
  function stopTimer() {
    clearInterval(timerInterval);
  }

  function startGame() {
    pedestrians.forEach(p => p.elem.remove());
    standingPeds.forEach(p => p.elem.remove());
    policeStandings.forEach(p => p.elem.remove());
    foods.forEach(f => f.elem.remove());
    medkits.forEach(m => m.elem.remove());
    bonuses.forEach(b => b.elem.remove());
    policeCars.forEach(p => p.elem.remove());
    pedestrians = [];
    standingPeds = [];
    policeStandings = [];
    foods = [];
    medkits = [];
    bonuses = [];
    policeCars = [];
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –º—É–∑—ã–∫—É
    initAudioContext();
    setTimeout(() => playBackgroundMusic(), 500);

    score = 0;
    lives = 3;
    gameTime = 0;
    comboCount = 0;
    speedX = isMobile ? 3 : 4;
    shieldActive = false;
    speedBoostActive = false;
    updateLivesDisplay();
    updateScoreDisplay();
    lifeCountElem.textContent = lives.toFixed(1);
    document.getElementById('timer').textContent = gameTime;
    gameOverFlag = false;
    paused = false;
    container.style.display = 'flex';
    info.style.display = 'block';
    livesElem.style.display = 'block';
    touchControls.style.display = isMobile ? 'flex' : 'none';
    recalcLanes();

    courierLane = 2;
    courierTargetLane = 2;
    courierCurrentY = lanePositions[courierLane] - courier.offsetHeight / 2;
    courier.style.top = courierCurrentY + 'px';

    updateDashSpeed();

    startSpawning();
    startTimer();

    lastFrameTime = 0;
    if (gameLoopId) cancelAnimationFrame(gameLoopId);
    gameLoopId = requestAnimationFrame(gameTick);
  }
  function stopGame() {
    cancelAnimationFrame(gameLoopId);
    stopSpawning();
    stopTimer();
    stopBackgroundMusic();
    pedestrians.forEach(p => p.elem.remove());
    standingPeds.forEach(p => p.elem.remove());
    policeStandings.forEach(p => p.elem.remove());
    foods.forEach(f => f.elem.remove());
    medkits.forEach(m => m.elem.remove());
    bonuses.forEach(b => b.elem.remove());
    policeCars.forEach(p => p.elem.remove());
    pedestrians = [];
    standingPeds = [];
    policeStandings = [];
    foods = [];
    medkits = [];
    bonuses = [];
    policeCars = [];
    touchControls.style.display = 'none';
    movingUp = false;
    movingDown = false;
    moveCooldown = 0;
  }

  function showGameOverAnimation() {
    container.style.display = 'none';
    info.style.display = 'none';
    livesElem.style.display = 'none';
    gameOverMenu.style.display = 'none';

    gtaGameOverScreen.style.display = 'flex';

    gtaGameOverScreen.style.animation = 'none';
    void gtaGameOverScreen.offsetWidth;
    gtaGameOverScreen.style.animation = 'gtaFadeInOut 5s forwards';

    setTimeout(() => {
      gtaGameOverScreen.style.display = 'none';
      finalScoreElem.textContent = Math.floor(score);
      gameOverMenu.style.display = 'block';
    }, 5000);
  }
  function gameOver() {
    if (gameOverFlag) return;
    gameOverFlag = true;
    stopGame();
    stopBackgroundMusic();
    playSound('gameOver');

    showGameOverAnimation();
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–µ–Ω—é
  playBtn.addEventListener('click', () => {
    mainMenu.style.display = 'none';
    startGame();
  });
  rulesBtn.addEventListener('click', () => {
    mainMenu.style.display = 'none';
    rulesDialog.style.display = 'block';
  });
  exitBtn.addEventListener('click', () => {
    mainMenu.style.display = 'none';
    container.style.display = 'none';
    info.style.display = 'none';
    livesElem.style.display = 'none';
    gameOverMenu.style.display = 'none';
    rulesDialog.style.display = 'none';
    gtaGameOverScreen.style.display = 'none';
    touchControls.style.display = 'none';
    stopGame();

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –æ–∫–Ω—É –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    window.parent.postMessage('closeGame', '*');

    setTimeout(() => {
      if (!window.closed) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –º—ã –≤ iframe –∏–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –æ–∫–Ω–µ
        if (window.parent !== window.self) {
          // –ú—ã –≤ iframe, –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
          window.parent.postMessage('closeGame', '*');
        } else {
          // –ú—ã –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
          window.location.href = window.location.origin;
        }
      }
    }, 500);
  });
  closeRulesBtn.addEventListener('click', () => {
    rulesDialog.style.display = 'none';
    mainMenu.style.display = 'block';
  });
  restartBtn.addEventListener('click', () => {
    gameOverMenu.style.display = 'none';
    startGame();
  });
  toMenuBtn.addEventListener('click', () => {
    gameOverMenu.style.display = 'none';
    mainMenu.style.display = 'block';
  });
  becomeBtn.addEventListener('click', () => {
    const referralLink = 'https://reg.eda.yandex.ru/?advertisement_campaign=forms_for_agents&user_invite_code=f123426cfad648a1afadad700e3a6b6b&utm_content=blank';
    window.open(referralLink, '_blank');
  });

  // –°–µ–Ω—Å–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  btnUp.addEventListener('touchstart', e => { e.preventDefault(); if (!gameOverFlag && !paused) movingUp = true; });
  btnUp.addEventListener('touchend', e => { e.preventDefault(); movingUp = false; });
  btnDown.addEventListener('touchstart', e => { e.preventDefault(); if (!gameOverFlag && !paused) movingDown = true; });
  btnDown.addEventListener('touchend', e => { e.preventDefault(); movingDown = false; });

  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
  window.addEventListener('keydown', e => {
    if (gameOverFlag || paused) return;
    if (e.key === 'ArrowUp' || e.key === 'w') movingUp = true;
    else if (e.key === 'ArrowDown' || e.key === 's') movingDown = true;
  });
  window.addEventListener('keyup', e => {
    if (e.key === 'ArrowUp' || e.key === 'w') movingUp = false;
    else if (e.key === 'ArrowDown' || e.key === 's') movingDown = false;
  });

  // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω 5 —Å–µ–∫—É–Ω–¥, –ø–æ—Ç–æ–º –º–µ–Ω—é
  window.addEventListener('load', () => {
    setTimeout(() => {
      welcomeScreen.style.display = 'none';
      mainMenu.style.display = 'block';
    }, 5000);
  });

  // –ü–µ—Ä–µ—Å—á—ë—Ç –ø–æ–ª–æ—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
  window.addEventListener('resize', () => {
    if (!gameOverFlag) recalcLanes();
  });
})();
</script>

</body>
</html>